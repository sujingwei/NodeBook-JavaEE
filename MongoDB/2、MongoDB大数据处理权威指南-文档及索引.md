## 一、MongoDB的文档存储

> 1）将文档插入到MongoDB的时候，文档是按照插入顺序，依次在磁盘上相邻保存，因此，一个文档变大了，原来的位置是放不下这个文档，就需要把这个文档移动动集合的另外一个位置，通常是最后，能放下这个文档的地方。
>
> 2）MongoDB移动文档的时候，会自动修改集合的填充因子(padding factor)，填充因子是为新文档预留的增长空间，不能手动设定填充因子。
>
> - 填充因子开始可能是1，也就是每个文档分配精确的空间，不预留增长空间
> - 当有文档超长而被迫移动文档的时候，填充因子会增大
> - 当集合中不再有文档移动的时候，填充因子会慢慢减少
>
> 3）MongoDB进行文档移动是非常慢的。移动文档的时候，MongoDB需要将文档原先占用的空间释放，然后将文档写入新的空间，相对费时，尤其是文档比较大，又频繁需要移动的话，会严重影响性能。
>
> 解决思路：在添加的时候添加一些没有意义的多移数据，这样在编辑的时候，没有超过占用空间，就不会移动数据了。
>
> 移动文档的时候，MongoDB需要将文档原先占用的空间释放，然后将文档写入新的空间，相对费时，尤其是文档比较大，又频繁需要移动的话，会严重影响性能。

## 二、性能优化

### 1、WiredTiger存储引擎

在mongodb3.0之前，默认使用的存储引擎是MMAPv1，但3.0之后出现了WiredTiger存储引擎，3.2之后成为了默认的存储引擎。大多数情况下使用WiredTiger存储引擎是最好的选择。

- 允许MongoDB完全支持文档级别锁定
- WiredTiger使用压缩算法之一，自动压缩数据，节省数据所需的存储空间

### 2、WiredTiger存储引擎内存使用方式

WiredTiger使用的内存模型可以在给定时间，把尽可能多的“相关”数据有效地保存在内存中。所谓“相关”是指为了实现目前在系统上有效的操作所需要的数据。在MongoDB中，内存中存储文档这个空间称为**缓存**。<span style="background:blue;color:#FFF;">默认情况下缓存的大小为系统内存的约一半</span>。可以通过wiredTigerCacheSizeGB命令行选项或storage.wiredTiger.engineConfig.cacheSizeGB YAML配置选项来调整。

注意：切勿把100%的系统内存都分配给MongoDB，否则操作系统将停止数据库过程！

#### 1）wiredTiger中的压缩

WiredTiger支持压缩磁盘上的数据。可以在数据存储的三个地方压缩数据：

* 集合中的数据
* 索引数据
* 日志数据

#### 2）评估查询性能

MongoDB有两个用于优化的查询性能的工具：explain()和MongoDB分析器。

MongoDB分析器是查找性能不佳的查询以及选择查询用于进一步检查的好工具

explain()是研究单个查询的好工具

##### （1）MongoDB分析器

**启用：**

```
db.setProfilingLevel(2)
```

