# 一、网关

我们需要一个微服网关，介于客户端与服务器这间的中间层，所有的外部请求都会经过微服务网关。客户端只需要与网关交互，只知道一个网关地址即可，这样简化了开发还有以下优点：

- 易于监控
- 易于认证
- 减少了客户端与各个微服务之间的交互次数

微服务网关也叫API网关，是系统对外的唯一入口。API网关封了系统内部架构，为每个客户端提供一个定制API。API网关方式的核心要点是，所有客户端和消费端都要通过统一的网关微服务，在网关层处理所有非业务功能，通常，网关也提供REST/HTTP的访问API。服务端通过API-GW注册和管理服务。

API网关可以实现的功能：

- 身份认证
- 监控
- 缓存
- 负载均衡
- 请求分片
- 静态响应

**常见的API网关实现方式**

|类型|描述|
|---|---|
|Kong|基于Nginx+Lua开发，性能高，稳定，有多个可用插件，开箱即用。只支持http协议，二次开发困难|
|zuul|Netfix开源，功能丰富，使用Java开发，易于二次开发；需要运行在web容器中，如Tomcat。问题：缺乏管控，无法动态配置；依赖组件较多；处理Http请求依赖是Web容器，性能不如Nginx|
|Treafik|Go语言开发；轻量易用；提供大多数功能：服务路由，负载均衡等；提供webUI。问题：进不进制文件部署，二次开发难度大；UI更多是监控，缺乏配置、管理功能力|
|Spring Cloud Gateway|Spring Cloud提供的网关服务|
|Nginx + lua|使用Nginx的反向代理和负载均衡可以实现对api服务器负载均衡及高可用。问题：自注册的问题和网关本身的扩展性|

## 1、nginx网关

利用反向代码实现

```nginx
location /api-product {
	proxy_pass http://127.0.0.1:9001;
}

location /api-order {
	proxy_pass http://127.0.0.1:9002;
}
```

## 2、Zuul网关

### 1）Zuul网关的介绍

zuul是Netfix开源的微服网关，它可以和Eureak、Ribbon、Hystrix等组件配置使用，Zuul组件的核心是一系列的过滤器，这些过滤器可以完成以下功能

- 动态路由：动态将请求路由到不同后端集群
- 压力测试：慢慢增加指向集群的流量，了解性能
- 负载分配：为每一种负载类型分配对应容量，弃用超出限定值的请求
- 静态响应处理：边缘位置进行响应，避免转发到内部集群
- 身份谁和安全：识别每一个资源的验证要求，并拒绝那些不符的请求。
- Spring Cloud的Zuul进行了整全增强。

Zuul的缺点：

- 同步阻塞式的访问，不利于大并发 (本质上上Servlet)
- 不支持 WebSocket

### 2）搭建zuul网关服务器

#### （1）创建工程导入依赖

```xml
<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>
```

#### （2）配置启动类，开启网关服务器功能

```java
@SpringBootApplication
/**
 * 开启 zuul 网关功能
 */
@EnableZuulProxy
public class ZuulApplication {
    public static void main(String[] args) {
        SpringApplication.run(ZuulApplication.class, args);
    }
}

```

#### （3）配置文件 & 路由配置

```yaml
server:
  port: 8080
spring:
  application:
    name: api-zuul-server  # 服务名称
    
zuul:
  routes:
    product-service:
      path: /product-service/**  # 配置映射路由
      url: http://127.0.0.1:9001 # 映射路由实际对应的微服务url地址
```

路由：根据请求的URL，将不同的请求转发到不同的服务中

访问`http://localhost:8080/product-service/product/1`，相当于通过反向代理访问 `http://127.0.0.1:9001/product/1`

### 3）简化路由配置

#### （1）添加eureka依赖

```xml
<!-- 这一步之前做过了 -->
<dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
```

#### （2）开启eureka的客户端服务

在启动类上加入：`@EnableDiscoveryClient // 也可以使用@EnableEurekaClient`即可

#### （3）在zuul网关服务中配置eureka中配置eureka的注册中心相关信息，及配置路由信息

```yaml
server:
  port: 8080
spring:
  application:
    name: api-zuul-server

eureka:
  client:
    service-url:
      defaultZone: http://localhost:10000/eureka/
  instance:
    prefer-ip-address: true
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    lease-expiration-duration-in-seconds: 30
    lease-renewal-interval-in-seconds: 5

zuul:
  routes:
    product-service:
      path: /product-service/**
      # url: http://localhost:9001
      serviceId: PRODUCT-SERVICE  # 配置转发的微服务的转发
```

#### （4）简化路由的配置

前提条件是当前服务加入到eureka中

如果我路由id 和 对应的微服务的 serviceId一致的话，可简化为：

```yaml
zuul:
  routes:
      product-service: /product-service/**
```

* 没有配置order-server的路由配置，但可以正常访问`http://localhost:8080/order-service/order/buy/1`，这个URL，因为不配置的话，使用默认 `order-service`服务名称作为url前缀

### 4）过滤器

Zuul的过滤器和Servlet里的Filter是不一样的。

![](img/e3f6911ea43e0f7326e4d44b4919254.png)

Zuul中过滤器总有4种

| 过滤器类型 | 描述                                                         |
| ---------- | ------------------------------------------------------------ |
| PRE        | 请求转发到服务之前执行的过滤器                               |
| ROUTING    | 在路由请求时执行的过滤器；用于构建发送给微服务的请求，并使用Apache,HttpClient或Netflix Ribbon请求微服务 |
| POST       | 执行微服务返回值之后执行的过滤器；可用来响应添加标准HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等 |
| ERROR      | 在其它阶段发生错误时执行的过滤器                             |

Zuul提供了自定义过滤器十分简单，只需编写一个类实现`ZuulFilter`接口即可

```java
/**
 * ZuulFilter Demo
 */
@Component  // 加入到容器中
public class LoginFilter extends ZuulFilter {
    /**
     * 用于定义过滤器类型,有以下4种类型
     * @return pre, routing, post ,error
     */
    @Override
    public String filterType() {
        return "pre";  // pre 类型的过滤器
    }

    /**
     * 用于指定过滤器的执行顺序
     *      - 返回值越少，执行顺序越高
     * @return
     */
    @Override
    public int filterOrder() {
        return 0;
    }

    /**
     * 当前过滤器是否生效
     *      true: 使用这个过滤器
     *      false: 不使用这个过滤器
     * @return
     */
    @Override
    public boolean shouldFilter() {
        return true;
    }

    /**
     * 执行过滤器的业务逻辑
     *
     * 在Zuul 网关中，通过RequestContext的上下文，可以获取request对象
     *
     * @return
     * @throws ZuulException
     */
    @Override
    public Object run() throws ZuulException {
        // 获取 zuul 提供的上下文件对象
        RequestContext ctx = RequestContext.getCurrentContext();
        // 得到request
        String token = ctx.getRequest().getParameter("access-token");
        if(token == null)
        {
            // 如果token==null,拦截请求，返回认证失败
            ctx.setSendZuulResponse(false);
            ctx.setResponseStatusCode(HttpStatus.SC_UNAUTHORIZED);
        }
        return null;  // 如果返回 null，就能后续执行
    }
}

```

- Zuul的过滤器是不需要要配置的，只要`shouldFilter`方法返回`true`，就会在请求的过程中自动运行。

## 3、Spring Cloud Gateway 网关

Spring Cloud Gateway是Spring官方基于Spring5.0，Spring Boot 2.0 和 Project Reactor等技术开发的网关，旨在为微服务提供一种简单而有效的统一API路由管理方式，统一访问接口。Spring Cloud Gateway作为Spring Cloud生态系统中的网关，目标是替代Netflix ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关的基本功能，例如：安全，监控/埋点，限流等。它是基于Nttey的响应式模式。

Spring Cloud Gateway是Zuul的性能上的1.6倍。

### 1）路由配置

### 2）过滤器

### 3）统一鉴权

### 4）网关限流

### 5）网关的高可用